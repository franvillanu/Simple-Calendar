<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>W03 January 2026 - Calendar</title>
    <script>
      (function () {
        const savedTheme = localStorage.getItem("simpleCalendarTheme");
        if (savedTheme === "dark") {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
    <style>
      :root {
        --surface: #ffffff;
        --surface-strong: #f5f7fb;
        --page-bg: #eef1f8;
        --toolbar: #ffffff;
        --text: #0f1117;
        --muted: #546074;
        --border: #e4e6ec;
        --card-title: #101317;
        --card-desc: rgba(15, 18, 23, 0.65);
        --shadow: 0 20px 45px rgba(15, 18, 23, 0.08);
        --shadow-deep: 0 25px 55px rgba(5, 8, 23, 0.15);
        --select-hover: rgba(82, 139, 255, 0.08);
        --select-selected: rgba(82, 139, 255, 0.12);
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-weight: normal;
        background: var(--page-bg);
        color: var(--text);
        min-height: 100vh;
      }

      label, input, select, textarea, option {
        font-weight: normal !important;
      }

      button {
        font-weight: 600 !important;
      }

      body,
      .modal {
        scrollbar-width: thin;
        scrollbar-color: rgba(15, 18, 23, 0.25) transparent;
      }

      body::-webkit-scrollbar,
      .modal::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      body::-webkit-scrollbar-thumb,
      .modal::-webkit-scrollbar-thumb {
        background: rgba(15, 18, 23, 0.35);
        border-radius: 999px;
      }

      body::-webkit-scrollbar-track,
      .modal::-webkit-scrollbar-track {
        background: transparent;
      }

      html.dark body {
        --surface: #1a1a1a;
        --surface-strong: #1f1f1f;
        --page-bg: #0f0f0f;
        --toolbar: #1a1a1a;
        --text: #e0e0e0;
        --muted: #a0a0a0;
        --border: rgba(255, 255, 255, 0.18);
        --card-title: #e0e0e0;
        --card-desc: rgba(224, 224, 224, 0.7);
        --shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
        --shadow-deep: 0 25px 80px rgba(0, 0, 0, 0.8);
        --select-hover: rgba(255, 255, 255, 0.05);
        --select-selected: rgba(255, 255, 255, 0.08);
        background: var(--page-bg);
      }

      html.dark body,
      html.dark .modal {
        scrollbar-color: rgba(255, 255, 255, 0.45) transparent;
      }

      html.dark body::-webkit-scrollbar-thumb,
      html.dark .modal::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.45);
      }

      .page {
        width: min(1200px, 100%);
        margin: 0 auto;
        padding: 30px 18px 60px;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .week-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .week-label {
        font-size: clamp(1.8rem, 2.6vw, 2.8rem);
        font-weight: 700;
      }

      .week-nav {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--toolbar);
        border-radius: 999px;
        padding: 6px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .week-nav button,
      .week-nav select {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 6px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: none;
      }

      .action-group button,
      .action-group select {
        border-radius: 20px;
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 10px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: none;
      }

      .week-nav button:hover,
      .week-nav select:hover {
        border-color: #999;
      }

      .action-group button:hover,
      .action-group select:hover {
        border-color: #999;
      }

      .week-nav select {
        appearance: none;
        background: transparent;
      }

      .year-pill {
        padding: 0 10px;
        border-radius: 999px;
        background: var(--surface-strong);
        border: 1px solid var(--border);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .action-group {
        display: flex;
        gap: 6px;
        align-items: center;
        background: var(--toolbar);
        border-radius: 999px;
        padding: 6px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        flex-wrap: wrap;
        margin-left: auto;
      }

      .language-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px;
        border-radius: 999px;
        box-shadow: none;
      }

      .action-group .language-toggle {
        padding: 4px;
        box-shadow: none;
      }

      .language-toggle span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 34px;
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
        color: var(--muted);
      }

      .language-toggle span.active {
        background: var(--surface);
        color: var(--text);
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
      }

      html.dark body .language-toggle span.active {
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
      }

      .export-menu {
        position: relative;
        display: inline-flex;
        align-items: center;
      }


      .export-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 6px;
        display: none;
        box-shadow: var(--shadow);
        min-width: 140px;
        z-index: 10;
      }

      .export-dropdown.open {
        display: block;
      }

      .export-dropdown button {
        width: 100%;
        text-align: left;
        border: none;
        background: transparent;
        padding: 8px 10px;
        border-radius: 10px;
        font-weight: 600;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .export-dropdown button:hover {
        background: var(--surface-strong);
      }

      .export-select {
        display: none;
      }

      .action-group button,
      .action-group select {
        height: 44px;
        box-shadow: none;
      }

      .theme-toggle {
        width: 44px;
        height: 44px;
        padding: 0;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .calendar-wrapper {
        background: var(--surface);
        border-radius: 30px;
        padding: 24px 28px 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .calendar-header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 16px;
        padding: 8px 6px 18px;
        position: relative;
        border-bottom: 1px solid var(--border);
      }

      .calendar-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .calendar-static {
        display: inline-flex;
        align-items: baseline;
        gap: 12px;
      }

      .calendar-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .calendar-month {
        display: flex;
        align-items: baseline;
        gap: 10px;
        text-transform: capitalize;
        font-size: 30px;
      }

      .calendar-year {
        display: inline-flex;
        align-items: baseline;
        gap: 8px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--muted);
        justify-self: end;
      }

      .calendar-week {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.8px;
        color: var(--muted);
      }

      .calendar-separator {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--muted);
        opacity: 0.6;
      }

      .calendar-controls {
        padding: 0;
        box-shadow: none;
        background: transparent;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0;
      }

      .calendar-controls button,
      .calendar-controls select {
        border: none;
        background: transparent;
        padding: 0 2px;
        font-size: 18px;
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
      }

      .calendar-controls select {
        font-weight: 700 !important;
        appearance: none;
        width: max-content;
        min-width: 0;
        padding: 0 2px;
      }

      .calendar-controls select option {
        font-size: 16px;
        line-height: 1.2;
      }

      .calendar-title-controls {
        font-size: 20px;
      }

      .calendar-title-controls {
        gap: 0;
      }

      .calendar-title-controls #month-select,
      .calendar-title-controls #prev-month,
      .calendar-title-controls #next-month {
        font-size: 30px;
        font-weight: 700;
        color: var(--text);
        padding: 0 2px;
      }

      #month-select {
        padding-right: 0;
      }

      .month-display {
        position: relative;
        display: inline-flex;
        align-items: baseline;
        justify-content: center;
        font-size: 30px;
        font-weight: 700;
        color: var(--text);
        white-space: nowrap;
        cursor: pointer;
      }

      .month-display select {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .calendar-title-controls #prev-month,
      .calendar-title-controls #next-month {
        width: 28px;
        text-align: center;
      }

      .calendar-week-controls {
        font-size: 20px;
      }

      #month-text {
        font-size: 30px;
        font-weight: 700;
        color: var(--text);
      }

      #week-text {
        font-size: 20px;
        font-weight: 600;
        color: var(--muted);
      }

      .calendar-wrapper.exporting .calendar-controls {
        display: none;
      }

      .calendar-wrapper.exporting .calendar-static {
        display: inline-flex;
      }

      .calendar-static {
        display: none;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0;
      }

      .day-cell {
        border: 1px solid var(--border);
        border-top: none;
        padding: 16px 18px;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: var(--surface);
      }

      .day-cell.weekend {
        background: var(--surface-strong);
      }

      html.dark body .day-cell.weekend {
        background: #2a2a2a;
      }

      html.dark body .calendar-wrapper {
        background: var(--surface-strong);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: var(--shadow-deep);
      }

      html.dark body .action-group button,
      html.dark body .action-group select {
        background: var(--surface);
        border-color: #2a2f4c;
        color: var(--text);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.45);
      }

      html.dark body .action-group {
        background: #1a1a1a;
        border-color: rgba(255, 255, 255, 0.18);
        box-shadow: var(--shadow-deep);
      }

      html.dark body .week-nav button,
      html.dark body .week-nav select {
        border-color: #2a2f4c;
        background: var(--surface);
        color: var(--text);
      }

      html.dark body .task-block {
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.6);
      }

      html.dark body .day-hover-add {
        background: rgba(255, 255, 255, 0.08);
        color: #f5f5f5;
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.55);
      }

      html.dark body .modal {
        background: var(--surface);
        border-color: var(--border);
      }

      html.dark body .modal #delete-task {
        background: rgba(255, 68, 68, 0.15);
        color: #ffb4b4;
      }

      .calendar-grid > .day-cell:nth-child(-n + 7) {
        border-top: none;
      }

      .day-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .day-number {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .day-name {
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--muted);
      }

      .day-tasks {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .task-block {
        border-radius: 14px;
        padding: 10px 12px;
        font-weight: 600;
        cursor: grab;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-height: 48px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
        position: relative;
        color: #111;
      }

      .day-tasks.drag-over {
        padding-bottom: 4px;
      }

      .drop-marker {
        height: 0;
        border-top: 2px dashed var(--border);
        margin: 4px 0;
      }

      .task-block .task-title {
        font-size: 0.95rem;
        color: #111;
      }

      .task-block .task-description {
        font-size: 0.78rem;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.65);
        line-height: 1.3rem;
        max-height: 2.6rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .task-block .edit-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(15, 18, 23, 0.15);
        font-size: 0.8rem;
        color: rgba(15, 18, 23, 0.7);
        pointer-events: none;
      }

      .calendar-wrapper.exporting .day-add-slot,
      .calendar-wrapper.exporting .task-block .edit-icon {
        visibility: hidden;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 18, 23, 0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 18px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }

      .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .modal {
        background: var(--surface);
        border-radius: 24px;
        padding: 22px 24px;
        width: min(620px, 100%);
        box-shadow: 0 35px 60px rgba(8, 10, 16, 0.2);
        position: relative;
      }

      .confirm-modal {
        width: auto;
        min-width: 320px;
        max-width: min(500px, 90%);
      }

      .confirm-modal p {
        margin-bottom: 12px;
        color: var(--muted);
        white-space: nowrap;
      }

      html.dark body .confirm-modal {
        color: #f5f5f5;
      }

      html.dark body .confirm-modal p {
        color: rgba(255, 255, 255, 0.85);
      }

      html.dark body .confirm-modal strong {
        color: #ffffff;
      }

      .confirm-modal strong {
        color: #111;
        font-weight: 700;
      }

      .confirm-modal label {
        margin-top: 16px;
      }

      .confirm-modal label:first-of-type {
        margin-top: 8px;
      }

      .confirm-modal select {
        margin-bottom: 0;
      }

      .help-list {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 1.25rem;
      }

      .help-list p {
        margin: 0;
        line-height: 1.2;
      }

      .help-section-title {
        margin-top: 24px;
        font-weight: 600;
        font-size: 1.31rem;
      }

      .help-section-title:first-child {
        margin-top: 0;
      }

      .help-row.section-end {
        margin-bottom: 14px;
      }

      .help-section-title + .help-row {
        margin-top: 8px;
      }

      .help-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.19rem;
      }

      [data-i18n="helpIntro"] {
        margin-bottom: 14px;
      }

      .help-key {
        font-weight: 700;
        white-space: nowrap;
      }

      .help-desc {
        white-space: nowrap;
      }

      .help-sep {
        opacity: 0.5;
      }

      .help-cards-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
        width: 100%;
      }

      .help-section {
        width: 100%;
      }

      .help-section-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--muted);
        margin-bottom: 12px;
        padding-left: 4px;
      }

      .help-section-label .icon {
        font-size: 1rem;
      }

      .help-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px 20px;
        width: 100%;
        box-sizing: border-box;
      }

      html.dark .help-card {
        background: var(--surface-strong);
        border-color: var(--border);
      }

      .help-card .help-list {
        font-size: 1rem;
        gap: 6px;
      }

      .help-card .help-row {
        font-size: 0.95rem;
        gap: 14px;
      }

      .help-card .help-key {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 32px;
        padding: 0 10px;
        background: var(--surface-strong);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      html.dark .help-card .help-key {
        background: var(--surface);
      }

      .help-disclaimer {
        background: rgba(255, 220, 150, 0.25);
        border: 1px solid rgba(200, 160, 80, 0.3);
        border-radius: 12px;
        padding: 16px 18px;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text);
        margin-top: 8px;
      }

      .help-disclaimer strong {
        color: #b8860b;
        font-weight: 600;
      }

      html.dark .help-disclaimer {
        background: rgba(180, 140, 60, 0.15);
        border-color: rgba(180, 140, 60, 0.25);
      }

      html.dark .help-disclaimer strong {
        color: #daa520;
      }

      .modal h2 {
        margin-bottom: 10px;
        font-size: 1.2rem;
      }

      #help-overlay .modal h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      .modal label {
        font-size: 0.75rem;
        font-weight: normal !important;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: var(--muted);
        display: block;
        margin-bottom: 8px;
        margin-top: 18px;
      }

      .modal label:first-of-type {
        margin-top: 0;
      }

      .modal input,
      .modal textarea,
      .modal select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px 16px;
        margin-top: 0;
        margin-bottom: 0;
        background: var(--surface-strong);
        font-size: 1rem;
        font-weight: normal;
        color: var(--text);
        box-sizing: border-box;
      }

      .custom-select-wrapper {
        position: relative;
        width: 100%;
      }

      .custom-select-wrapper + .custom-select-wrapper {
        margin-top: 14px;
      }

      .custom-select-button {
        width: 100%;
        border-radius: 18px;
        border: 1px solid var(--border);
        background: var(--surface-strong);
        padding: 14px 18px;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        font-weight: normal !important;
        color: var(--text);
        cursor: pointer;
        box-shadow: inset 0 0 0 1px rgba(15, 18, 23, 0.04);
        transition: border-color 0.2s ease;
      }

      .custom-select-button:hover {
        border-color: rgba(15, 18, 23, 0.35);
      }

      .custom-select-panel {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface-strong);
        border-radius: 0 0 18px 18px;
        border: 1px solid var(--border);
        border-top: none;
        box-shadow: 0 25px 50px rgba(15, 18, 23, 0.14);
        max-height: 260px;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateY(6px);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        z-index: 12;
        padding: 0;
        font-weight: normal !important;
      }

      .custom-select-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .custom-select-option {
        width: 100%;
        border: none;
        background: none;
        text-align: left;
        padding: 12px 20px;
        font-size: 1rem;
        color: var(--text);
        cursor: pointer;
        font-weight: normal !important;
        line-height: 1.4;
        border-radius: 0;
      }

      .custom-select-option:hover {
        background: rgba(82, 139, 255, 0.12);
        border-radius: 0;
      }

      .custom-select-option.is-selected {
        background: rgba(82, 139, 255, 0.18);
        border-radius: 0;
      }

      html.dark {
        --select-hover: rgba(255, 255, 255, 0.05);
        --select-selected: rgba(255, 255, 255, 0.08);
      }

      .custom-select-button .custom-select-arrow {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: auto;
        height: auto;
        border-radius: 0;
        background: transparent;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .hidden-native-select {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
        pointer-events: none;
        border: none;
      }

      .modal textarea {
        resize: vertical;
        min-height: 110px;
      }

      .palette {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-bottom: 14px;
        margin-top: 6px;
      }

      .palette button {
        border-radius: 12px;
        border: 3px solid transparent;
        width: 100%;
        aspect-ratio: 1 / 1;
        cursor: pointer;
      }

      .palette button.selected {
        border-color: var(--muted);
        box-shadow: 0 0 0 2px var(--surface), 0 0 0 4px var(--muted);
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        margin-top: 6px;
      }

      #move-overlay .modal-actions {
        margin-top: 24px;
      }

      .field-error {
        font-size: 0.75rem;
        color: #c53030;
        margin-top: 6px;
        margin-bottom: 0;
        padding-left: 2px;
        display: none;
      }

      html.dark body .field-error {
        color: #fc8181;
      }

      .modal button {
        border-radius: 14px;
        border: none;
        padding: 8px 14px;
        font-weight: 600;
        cursor: pointer;
        transition: none;
      }

      .modal button.primary {
        background: #1f6be7;
        color: #fff;
      }

      .modal button.secondary {
        background: #eeeeee;
        color: #2c2c2c;
      }

      .modal button.danger {
        background: #b42318;
        color: #ffffff;
      }

      .modal #delete-task {
        background: #ffe6e6;
        color: #b42318;
      }

      .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        border: none;
        background: transparent;
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--muted);
      }

      .day-add-slot {
        width: 100%;
        min-height: 48px;
        border-radius: 14px;
        border: 1px dashed rgba(31, 31, 31, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.95rem;
        color: #222;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        background: rgba(255, 255, 255, 0.9);
        transition: opacity 0.2s ease;
      }

      .day-cell:hover .day-add-slot {
        opacity: 1;
        pointer-events: auto;
      }

      .day-cell.hide-add .day-add-slot {
        opacity: 0;
        pointer-events: none;
      }

      html.dark body .day-add-slot {
        background: rgba(255, 255, 255, 0.08);
        color: #f5f5f5;
        border-color: rgba(255, 255, 255, 0.2);
      }

      body.dragging .day-add-slot {
        pointer-events: none;
        opacity: 0;
      }

      .fullscreen-warning {
        font-size: 0.9rem;
        color: var(--muted);
      }

      @media (max-width: 900px) {
        .calendar-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 600px) {
        .calendar-grid {
          grid-template-columns: 1fr;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .week-nav,
        .action-group {
          width: 100%;
          justify-content: flex-start;
        }
      }

      /* Week Dots Strip */
      .week-dots-strip {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        padding: 14px 20px 16px;
        background: var(--surface);
        border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .week-dots-content {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        gap: 2px;
      }

      .week-dots-month-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }

      .week-dots-month-dots {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 4px 6px;
        border-radius: 10px;
        background: transparent;
        transition: background 0.2s ease;
      }

      .week-dots-month-group.is-current-month .week-dots-month-dots {
        background: rgba(126, 184, 218, 0.15);
      }

      html.dark body .week-dots-month-group.is-current-month .week-dots-month-dots {
        background: rgba(90, 159, 196, 0.2);
      }

      .week-dots-month-label {
        font-size: 0.58rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        opacity: 0.5;
        white-space: nowrap;
      }

      .week-dots-month-group.is-current-month .week-dots-month-label {
        opacity: 1;
        color: #7eb8da;
      }

      html.dark body .week-dots-month-group.is-current-month .week-dots-month-label {
        color: #5a9fc4;
      }

      .week-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--border);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        position: relative;
        flex-shrink: 0;
      }

      .week-dot:hover {
        transform: scale(1.4);
      }

      .week-dot.has-content {
        background: #7eb8da;
      }

      html.dark body .week-dot.has-content {
        background: #5a9fc4;
      }

      .week-dot.is-current {
        box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px var(--text);
      }

      .week-dot.is-current.has-content {
        box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px #7eb8da;
      }

      html.dark body .week-dot.is-current.has-content {
        box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px #5a9fc4;
      }

      .week-dot-tooltip {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--text);
        color: var(--surface);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease;
        z-index: 10;
      }

      .week-dot:hover .week-dot-tooltip {
        opacity: 1;
      }

      .week-dot-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: var(--text);
      }

      @media (max-width: 900px) {
        .week-dots-strip {
          padding: 12px 14px 14px;
        }

        .week-dots-month-group {
          gap: 5px;
        }

        .week-dots-month-dots {
          gap: 4px;
          padding: 3px 5px;
        }

        .week-dot {
          width: 10px;
          height: 10px;
        }

        .week-dots-month-label {
          font-size: 0.5rem;
        }
      }

      @media (max-width: 600px) {
        .week-dots-strip {
          padding: 10px 12px 12px;
        }

        .week-dots-content {
          flex-wrap: wrap;
          gap: 4px;
        }

        .week-dots-month-group {
          gap: 4px;
        }

        .week-dots-month-dots {
          gap: 3px;
          padding: 2px 4px;
        }

        .week-dot {
          width: 8px;
          height: 8px;
        }

        .week-dots-month-label {
          font-size: 0.45rem;
        }
      }

    </style>
  </head>
  <body>
    <div class="page">
      <header>
        
        <div class="action-group">
          <button id="language-toggle" class="language-toggle" aria-label="Language">
            <span data-lang="es">ES</span>
            <span data-lang="en">EN</span>
          </button>
          <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">üåô</button>
          <button id="clear-week" aria-label="Clear week">üóëÔ∏è</button>
          <button id="help-toggle" class="theme-toggle" aria-label="Help">‚ùì</button>
          <div class="export-menu">
            <button id="export-button" data-i18n="exportButton" aria-expanded="false">Export</button>
            <div class="export-dropdown" id="export-dropdown" role="menu" aria-label="Export format menu">
              <button type="button" data-format="png">üñºÔ∏è PNG</button>
              <button type="button" data-format="pdf">üìÑ PDF</button>
            </div>
          </div>
          <select id="export-format" class="export-select custom-select" aria-hidden="true" tabindex="-1">
            <option value="png">PNG</option>
            <option value="pdf">PDF</option>
          </select>
        </div>
      </header>

      <section class="calendar-wrapper">
        <div class="calendar-header">
          <div class="calendar-left">
            <div class="calendar-static">
              <span id="month-text">January</span>
            </div>
            <div class="calendar-controls calendar-title-controls">
              <button id="prev-month" aria-label="Previous month">&lsaquo;</button>
              <span class="month-display" id="month-display">
                <span id="month-display-text">Enero</span>
                <select id="month-select" aria-label="Month"></select>
              </span>
              <button id="next-month" aria-label="Next month">&rsaquo;</button>
            </div>
          </div>
          <div class="calendar-center">
            <div class="calendar-static">
              <span id="week-text">Semana 03</span>
            </div>
            <div class="calendar-controls calendar-week-controls">
              <button id="prev-week" aria-label="Previous week">&lsaquo;</button>
              <select id="week-select" aria-label="Week"></select>
              <button id="next-week" aria-label="Next week">&rsaquo;</button>
            </div>
          </div>
          <div class="calendar-year">
            <span class="calendar-static" id="year-text">2026</span>
            <div class="calendar-controls calendar-year-controls">
              <button id="prev-year" aria-label="Previous year">&lsaquo;</button>
              <select id="year-select" aria-label="Year"></select>
              <button id="next-year" aria-label="Next year">&rsaquo;</button>
            </div>
          </div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </section>

      <div class="week-dots-strip" id="week-dots-strip"></div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
      <div class="modal" role="dialog" aria-modal="true">
        <button class="close-btn" id="close-modal" aria-label="Close modal">&times;</button>
        <h2 data-i18n="modalTitle">Agregar bloque</h2>
        <p class="fullscreen-warning" data-i18n="modalHint" style="display:none;"></p>
        <form id="task-form">
          <label for="task-day" data-i18n="dayLabel">Dia</label>
          <select id="task-day" name="day" data-custom="true"></select>

          <label for="task-title" data-i18n="titleLabel">Titulo</label>
          <input id="task-title" name="title" data-i18n-placeholder="titlePlaceholder" />
          <div class="field-error" id="title-error" data-i18n="titleRequired">Titulo obligatorio</div>

          <label for="task-description" data-i18n="descLabel">Descripcion</label>
          <textarea
            id="task-description"
            name="description"
            data-i18n-placeholder="descPlaceholder"
            rows="3"
          ></textarea>

          <label data-i18n="paletteLabel">Paleta</label>
          <div class="palette" id="color-palette"></div>

          <div class="modal-actions">
            <div style="display:flex; gap:8px;">
              <button type="button" class="secondary" id="delete-task" style="display:none;" data-i18n="deleteBlock">Eliminar bloque</button>
              <button type="button" class="secondary" id="move-task" style="display:none;" data-i18n="moveBlock">Mover bloque</button>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px;">
              <button type="button" class="secondary" id="cancel-modal" data-i18n="cancelBlock">Cancelar</button>
              <button type="submit" class="primary" data-i18n="saveBlock">Guardar bloque</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div id="confirm-overlay" class="modal-overlay">
      <div class="modal confirm-modal" role="dialog" aria-modal="true">
        <h2 data-i18n="confirmTitle">Descartar cambios</h2>
        <p data-i18n="confirmMessage">Tienes cambios sin guardar. Deseas cancelar?</p>
        <div class="modal-actions">
          <button type="button" class="primary" id="confirm-stay" data-i18n="confirmStay">Seguir editando</button>
          <button type="button" class="danger" id="confirm-discard" data-i18n="confirmDiscard">Descartar</button>
        </div>
      </div>
    </div>

    <div id="delete-block-overlay" class="modal-overlay">
      <div class="modal confirm-modal" role="dialog" aria-modal="true">
        <h2 data-i18n="deleteConfirmTitle">Eliminar bloque</h2>
        <p data-i18n="deleteConfirmMessage">Seguro que quieres eliminar este bloque?</p>
        <div class="modal-actions">
          <button type="button" class="secondary" id="delete-block-cancel" data-i18n="deleteConfirmCancel">Cancelar</button>
          <button type="button" class="danger" id="delete-block-confirm" data-i18n="deleteConfirmAction">Eliminar bloque</button>
        </div>
      </div>
    </div>

    <div id="move-overlay" class="modal-overlay">
      <div class="modal confirm-modal" role="dialog" aria-modal="true">
        <h2 data-i18n="moveTitle">Mover bloque</h2>
        <label for="move-year" data-i18n="moveYearLabel">A√±o</label>
        <select id="move-year" data-custom="true"></select>
        <label for="move-week" data-i18n="moveWeekLabel">Semana</label>
        <select id="move-week" data-custom="true"></select>
        <label for="move-day" data-i18n="moveDayLabel">D√≠a</label>
        <select id="move-day" data-custom="true"></select>
        <div class="modal-actions">
          <button type="button" class="secondary" id="move-cancel" data-i18n="moveCancel">Cancelar</button>
          <button type="button" class="primary" id="move-confirm" data-i18n="moveConfirm">Mover bloque</button>
        </div>
      </div>
    </div>

    <div id="clear-week-overlay" class="modal-overlay">
      <div class="modal confirm-modal" role="dialog" aria-modal="true">
        <h2 data-i18n="clearWeekTitle">Limpiar semana</h2>
        <p id="clear-week-message">Are you sure you want to Clean "January - Week 3"?</p>
        <div class="modal-actions">
          <button type="button" class="secondary" id="clear-week-cancel" data-i18n="clearWeekCancel">Cancel</button>
          <button type="button" class="danger" id="clear-week-confirm" data-i18n="clearWeekConfirm">Remove all blocks</button>
        </div>
      </div>
    </div>

    <div id="restore-week-overlay" class="modal-overlay">
      <div class="modal confirm-modal" role="dialog" aria-modal="true">
        <h2 data-i18n="restoreWeekTitle">Restaurar ejemplo</h2>
        <p id="restore-week-message">Add sample week data on top of your current blocks?</p>
        <div class="modal-actions">
          <button type="button" class="secondary" id="restore-week-cancel" data-i18n="restoreWeekCancel">Cancel</button>
          <button type="button" class="primary" id="restore-week-confirm" data-i18n="restoreWeekConfirm">Add sample</button>
        </div>
      </div>
    </div>

    <div id="help-overlay" class="modal-overlay">
      <div class="modal" role="dialog" aria-modal="true">
        <button class="close-btn" id="help-close" aria-label="Close help">&times;</button>
        <h2 data-i18n="helpTitle">Gu√≠a R√°pida</h2>
        <div class="help-cards-container">
          <div class="help-section">
            <div class="help-section-label">
              <span class="icon">&#x2328;&#xFE0F;</span>
              <span data-i18n="helpNavTitle">Atajos de Teclado</span>
            </div>
            <div class="help-card">
              <div class="help-list">
                <div class="help-row">
                  <span class="help-key">&#x2B05;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow1">Semana anterior</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x27A1;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow2">Semana siguiente</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x2B06;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow3">Mes siguiente</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x2B07;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow4">Mes anterior</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x1F3E0;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow5">Home: Primera semana del a√±o</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x1F51A;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpNavRow6">End: √öltima semana del a√±o</span>
                </div>
              </div>
            </div>
          </div>

          <div class="help-section">
            <div class="help-section-label">
              <span class="icon">&#x1F5A5;&#xFE0F;</span>
              <span data-i18n="helpUiTitle">Interfaz de Usuario</span>
            </div>
            <div class="help-card">
              <div class="help-list">
                <div class="help-row">
                  <span class="help-key">ES/GB</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpUiLang">Idioma: Espa√±ol/Ingl√©s</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x1F319;/&#x2600;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpUiTheme">Modo: Oscuro o claro</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x1F5D1;&#xFE0F;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpUiClear">Limpiar semana (si est√° vac√≠a: + agrega ejemplo)</span>
                </div>
                <div class="help-row">
                  <span class="help-key">&#x1F4E4;</span>
                  <span class="help-sep">:</span>
                  <span class="help-desc" data-i18n="helpUiExport">Exportar: PNG o PDF</span>
                </div>
              </div>
            </div>
          </div>

          <div class="help-disclaimer">
            <strong data-i18n="helpDisclaimerLabel">Aviso:</strong>
            <span data-i18n="helpDisclaimerBody">Esta aplicaci√≥n funciona localmente en el navegador. Cada navegador guarda su propio calendario de forma independiente. Cambiar de navegador o de dispositivo no borra tus datos: simplemente usar√°s un calendario nuevo en ese entorno. El calendario solo se elimina si se borran manualmente los datos del navegador donde fue creado.</span>
          </div>
        </div>
      </div>
    </div>
<script src="html2canvas.min.js"></script>
    <script src="jspdf.umd.min.js"></script>
    <script>
      const lightPaletteColors = [
        "#d5f4e6",
        "#d6eaf8",
        "#ebdef0",
        "#fef5e7",
        "#f2e6f7",
        "#ecf0f1",
        "#e5e7e9",
        "#fadbd8",
        "#ffd9ca",
        "#dcf6ff",
      ];

      const darkPaletteColors = [
        "#9ad9c8",
        "#9fc7ea",
        "#c5b3e0",
        "#e1c89a",
        "#c7b1e5",
        "#aeb7bd",
        "#98a3ad",
        "#e0a7a1",
        "#e8a090",
        "#a0d4e8",
      ];

      let paletteColors = lightPaletteColors;

      const years = [2026, 2027, 2028, 2029, 2030];
      const i18n = {
        es: {
          modalTitle: "Agregar bloque",
          modalHint: "Clic fuera del modal para cerrar sin guardar.",
          dayLabel: "D√≠a",
          titleLabel: "T√≠tulo",
          titlePlaceholder: "Da un nombre corto",
          titleRequired: "T√≠tulo obligatorio",
          descLabel: "Descripci√≥n",
          descPlaceholder: "Notas adicionales",
          paletteLabel: "Paleta",
          saveBlock: "Guardar bloque",
          deleteBlock: "Eliminar bloque",
          cancelBlock: "Cancelar",
          exportPng: "Exportar PNG",
          exportPdf: "Exportar PDF",
          exportButton: "Exportar",
          addBlock: "Agregar bloque",
          weekPrefix: "W",
          weekSelect: "Semana",
          clearWeek: "üóëÔ∏è",
          clearWeekTitle: "Limpiar semana",
          clearWeekCancel: "Cancelar",
          clearWeekConfirm: "Eliminar todos los bloques",
          restoreWeekTitle: "Restaurar ejemplo",
          restoreWeekCancel: "Cancelar",
          restoreWeekConfirm: "Agregar ejemplo",
          helpTitle: "Gu√≠a R√°pida",
          helpNavTitle: "Atajos de Teclado",
          helpNavRow1: "Semana anterior",
          helpNavRow2: "Semana siguiente",
          helpNavRow3: "Mes siguiente",
          helpNavRow4: "Mes anterior",
          helpNavRow5: "Home: Primera semana del a√±o",
          helpNavRow6: "End: √öltima semana del a√±o",
          helpUiTitle: "Interfaz de Usuario",
          helpUiLang: "Idioma: Espa√±ol/Ingl√©s",
          helpUiTheme: "Modo: Oscuro o claro",
          helpUiClear: "Limpiar semana (si est√° vac√≠a: + agrega ejemplo)",
          helpUiExport: "Exportar: PNG o PDF",
          helpDisclaimerLabel: "Aviso:",
          helpDisclaimerBody: "Esta aplicaci√≥n funciona localmente en el navegador. Cada navegador guarda su propio calendario de forma independiente. Cambiar de navegador o de dispositivo no borra tus datos: simplemente usar√°s un calendario nuevo en ese entorno. El calendario solo se elimina si se borran manualmente los datos del navegador donde fue creado.",
          confirmTitle: "Descartar cambios",
          confirmMessage: "Tienes cambios sin guardar. ¬øDeseas cancelar?",
          confirmStay: "Seguir editando",
          confirmDiscard: "Descartar",
          deleteConfirmTitle: "Eliminar bloque",
          deleteConfirmMessage: "¬øSeguro que quieres eliminar este bloque?",
          deleteConfirmCancel: "Cancelar",
          deleteConfirmAction: "Eliminar bloque",
          moveTitle: "Mover bloque",
          moveYearLabel: "A√±o",
          moveWeekLabel: "Semana",
          moveDayLabel: "D√≠a",
          moveCancel: "Cancelar",
          moveConfirm: "Mover bloque",
          moveBlock: "Mover bloque",
        },
        en: {
          modalTitle: "Add block",
          modalHint: "Click outside to close without saving.",
          dayLabel: "Day",
          titleLabel: "Title",
          titlePlaceholder: "Short name",
          titleRequired: "Title is required",
          descLabel: "Description",
          descPlaceholder: "Additional notes",
          paletteLabel: "Palette",
          saveBlock: "Save block",
          deleteBlock: "Delete block",
          cancelBlock: "Cancel",
          exportPng: "Export PNG",
          exportPdf: "Export PDF",
          exportButton: "Export",
          addBlock: "Add block",
          weekPrefix: "W",
          weekSelect: "Week",
          clearWeek: "üóëÔ∏è",
          clearWeekTitle: "Clear week",
          clearWeekCancel: "Cancel",
          clearWeekConfirm: "Remove all blocks",
          restoreWeekTitle: "Restore sample",
          restoreWeekCancel: "Cancel",
          restoreWeekConfirm: "Add sample",
          helpTitle: "Quick Guide",
          helpNavTitle: "Keyboard Shortcuts",
          helpNavRow1: "Previous week",
          helpNavRow2: "Next week",
          helpNavRow3: "Next month",
          helpNavRow4: "Previous month",
          helpNavRow5: "Home: First week of the year",
          helpNavRow6: "End: Last week of the year",
          helpUiTitle: "User Interface",
          helpUiLang: "Language: Spanish/English",
          helpUiTheme: "Mode: Dark or light",
          helpUiClear: "Clear week (if empty: + add sample)",
          helpUiExport: "Export: PNG or PDF",
          helpDisclaimerLabel: "Notice:",
          helpDisclaimerBody: "This app runs locally in your browser. Each browser saves its own calendar independently. Switching browsers or devices doesn't delete your data: you'll simply use a new calendar in that environment. Your calendar is only deleted if you manually clear the browser data where it was created.",
          confirmTitle: "Discard changes",
          confirmMessage: "You have unsaved changes. Do you want to cancel?",
          confirmStay: "Keep editing",
          confirmDiscard: "Discard",
          deleteConfirmTitle: "Delete block",
          deleteConfirmMessage: "Are you sure you want to delete this block?",
          deleteConfirmCancel: "Cancel",
          deleteConfirmAction: "Delete",
          moveTitle: "Move block",
          moveYearLabel: "Year",
          moveWeekLabel: "Week",
          moveDayLabel: "Day",
          moveCancel: "Cancel",
          moveConfirm: "Move block",
          moveBlock: "Move block",
        },
      };

  function getSampleTasks(lang, paletteColors) {
    if (lang === "es") {
      return [
        [{ title: "Bloque de estudio", description: "", color: paletteColors[0], type: "task" }],
        [{ title: "Trabajo de proyecto", description: "", color: paletteColors[1], type: "task" }],
        [
          { title: "Tiempo de enfoque", description: "", color: paletteColors[0], type: "task" },
          { title: "Almuerzo", description: "", color: paletteColors[3], type: "task" },
          { title: "Trabajo profundo", description: "", color: paletteColors[0], type: "task" },
        ],
        [
          { title: "Taller", description: "", color: paletteColors[2], type: "task" },
          { title: "Almuerzo", description: "", color: paletteColors[3], type: "task" },
        ],
        [
          { title: "Inbox cero", description: "", color: paletteColors[5], type: "task" },
          { title: "Gimnasio", description: "Sesi√≥n de tarde", color: paletteColors[7], type: "task" },
        ],
      ];
    }

    return [
      [{ title: "Study block", description: "", color: paletteColors[0], type: "task" }],
      [{ title: "Project work", description: "", color: paletteColors[1], type: "task" }],
      [
        { title: "Focus time", description: "", color: paletteColors[0], type: "task" },
        { title: "Lunch", description: "", color: paletteColors[3], type: "task" },
        { title: "Deep work", description: "", color: paletteColors[0], type: "task" },
      ],
      [
        { title: "Workshop", description: "", color: paletteColors[2], type: "task" },
        { title: "Lunch", description: "", color: paletteColors[3], type: "task" },
      ],
      [
        { title: "Inbox zero", description: "", color: paletteColors[5], type: "task" },
        { title: "Gym", description: "Evening session", color: paletteColors[7], type: "task" },
      ],
    ];
  }

  function buildDefaultTasks(lang) {
    const sampleTasks = getSampleTasks(lang, lightPaletteColors);
    return {
      "2026-03": {
        12: sampleTasks[0],
        13: sampleTasks[1],
        14: sampleTasks[2],
        15: sampleTasks[3],
        16: sampleTasks[4],
      },
    };
  }

  const initialLang =
    localStorage.getItem("simpleCalendarLang") && i18n[localStorage.getItem("simpleCalendarLang")]
      ? localStorage.getItem("simpleCalendarLang")
      : "es";
  const defaultTasks = buildDefaultTasks(initialLang);

function loadTasks() {
  try {
    const raw = localStorage.getItem("simpleCalendarTasks");
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : null;
  } catch (error) {
    return null;
  }
}

function saveTasks(tasks) {
  try {
    localStorage.setItem("simpleCalendarTasks", JSON.stringify(tasks));
  } catch (error) {
    return;
  }
}

const state = {
  week: 3,
  year: 2026,
  month: null,
  exportFormat: "png",
  lang: "es",
  color: lightPaletteColors[0],
  tasks: loadTasks() || defaultTasks,
};
      let editingTask = null;

      const calendarGrid = document.getElementById("calendar-grid");
      const monthSelect = document.getElementById("month-select");
      const weekSelect = document.getElementById("week-select");
      const yearSelect = document.getElementById("year-select");
      const monthText = document.getElementById("month-text");
      const monthDisplay = document.getElementById("month-display");
      const monthDisplayText = document.getElementById("month-display-text");
      const weekText = document.getElementById("week-text");
      const yearText = document.getElementById("year-text");
      const taskDaySelect = document.getElementById("task-day");
      const paletteEl = document.getElementById("color-palette");
      const themeToggle = document.getElementById("theme-toggle");
      const languageToggle = document.getElementById("language-toggle");
      const taskForm = document.getElementById("task-form");
      const exportFormat = document.getElementById("export-format");
      const exportDropdown = document.getElementById("export-dropdown");
      const exportButton = document.getElementById("export-button");
      const clearWeekButton = document.getElementById("clear-week");
      const modalOverlay = document.getElementById("modal-overlay");
      const modal = document.querySelector(".modal");
      const closeModalButton = document.getElementById("close-modal");
      const deleteButton = document.getElementById("delete-task");
      const cancelButton = document.getElementById("cancel-modal");
      const confirmOverlay = document.getElementById("confirm-overlay");
      const confirmStay = document.getElementById("confirm-stay");
      const confirmDiscard = document.getElementById("confirm-discard");
      const clearWeekOverlay = document.getElementById("clear-week-overlay");
      const clearWeekMessage = document.getElementById("clear-week-message");
      const clearWeekCancel = document.getElementById("clear-week-cancel");
      const clearWeekConfirm = document.getElementById("clear-week-confirm");
      const helpToggle = document.getElementById("help-toggle");
      const helpOverlay = document.getElementById("help-overlay");
      const helpClose = document.getElementById("help-close");
      const restoreWeekOverlay = document.getElementById("restore-week-overlay");
      const restoreWeekMessage = document.getElementById("restore-week-message");
      const restoreWeekCancel = document.getElementById("restore-week-cancel");
      const restoreWeekConfirm = document.getElementById("restore-week-confirm");
      const deleteConfirmOverlay = document.getElementById("delete-block-overlay");
      const deleteConfirmCancel = document.getElementById("delete-block-cancel");
      const deleteConfirmConfirm = document.getElementById("delete-block-confirm");
      const moveButton = document.getElementById("move-task");
      const moveOverlay = document.getElementById("move-overlay");
      const moveYearSelect = document.getElementById("move-year");
      const moveWeekSelect = document.getElementById("move-week");
      const moveDaySelect = document.getElementById("move-day");
      const moveCancelButton = document.getElementById("move-cancel");
      const moveConfirmButton = document.getElementById("move-confirm");
      const titleError = document.getElementById("title-error");
      const dropMarker = document.createElement("div");
      dropMarker.className = "drop-marker";
      let currentDropContainer = null;
      let currentDropIndex = null;
      let formDirty = false;
      let monthLock = false;
      const customSelectRegistry = new Map();
      let activeCustomSelect = null;
      registerCustomSelects();

      function clearDropMarker() {
        if (currentDropContainer) {
          currentDropContainer.classList.remove("drag-over");
        }
        if (dropMarker.parentNode) {
          dropMarker.parentNode.removeChild(dropMarker);
        }
        currentDropContainer = null;
        currentDropIndex = null;
      }

      function attachOverlayCloseGuard(overlay, onClose) {
        if (!overlay) {
          return;
        }
        let pointerDownOnBackdrop = false;
        overlay.addEventListener("pointerdown", (event) => {
          pointerDownOnBackdrop = event.target === overlay;
        });
        overlay.addEventListener("pointerup", (event) => {
          pointerDownOnBackdrop = pointerDownOnBackdrop && event.target === overlay;
        });
        overlay.addEventListener("click", (event) => {
          if (event.target !== overlay) {
            return;
          }
          if (!pointerDownOnBackdrop) {
            return;
          }
          pointerDownOnBackdrop = false;
          onClose(event);
        });
      }

      function registerCustomSelects() {
        document.querySelectorAll("select[data-custom]").forEach((selectEl) => {
          if (!selectEl || customSelectRegistry.has(selectEl)) return;
          const wrapper = document.createElement("div");
          wrapper.className = "custom-select-wrapper";
          const button = document.createElement("button");
          button.type = "button";
          button.className = "custom-select-button";
          button.setAttribute("aria-haspopup", "listbox");
          button.setAttribute("aria-expanded", "false");
          const valueSpan = document.createElement("span");
          valueSpan.className = "custom-select-value";
          const arrowSpan = document.createElement("span");
          arrowSpan.className = "custom-select-arrow";
          arrowSpan.textContent = "‚ñæ";
          button.append(valueSpan, arrowSpan);
          const panel = document.createElement("div");
          panel.className = "custom-select-panel";
          panel.setAttribute("role", "listbox");
          panel.setAttribute("tabindex", "-1");
          selectEl.parentNode.insertBefore(wrapper, selectEl);
          wrapper.append(button, panel, selectEl);
          selectEl.classList.add("hidden-native-select");
          selectEl.setAttribute("aria-hidden", "true");
          selectEl.tabIndex = -1;
          const record = { selectEl, wrapper, button, panel, valueSpan };
          customSelectRegistry.set(selectEl, record);
          button.addEventListener("click", (event) => {
            event.preventDefault();
            toggleCustomSelect(record);
          });
          panel.addEventListener("click", (event) => {
            const optionButton = event.target.closest("[data-value]");
            if (!optionButton || optionButton.disabled) return;
            selectEl.value = optionButton.dataset.value;
            selectEl.dispatchEvent(new Event("change", { bubbles: true }));
            closeCustomSelect(record);
          });
          selectEl.addEventListener("change", () => {
            updateCustomSelectDisplay(record);
          });
          updateCustomSelect(record);
        });
      }

      function updateCustomSelect(record) {
        const { selectEl, panel } = record;
        panel.innerHTML = "";
        selectEl.querySelectorAll("option").forEach((option) => {
          const optionButton = document.createElement("button");
          optionButton.type = "button";
          optionButton.className = "custom-select-option";
          optionButton.dataset.value = option.value;
          optionButton.textContent = option.textContent;
          if (option.disabled) {
            optionButton.disabled = true;
          }
          panel.appendChild(optionButton);
        });
        updateCustomSelectDisplay(record);
      }

      function updateCustomSelectDisplay(record) {
        const { selectEl, button, valueSpan, panel } = record;
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        valueSpan.textContent = selectedOption ? selectedOption.textContent : "";
        panel.querySelectorAll(".custom-select-option").forEach((elem) => {
          elem.classList.toggle("is-selected", elem.dataset.value === selectEl.value);
        });
        button.setAttribute("aria-expanded", panel.classList.contains("open") ? "true" : "false");
      }

      function toggleCustomSelect(record) {
        const isOpen = record.panel.classList.contains("open");
        closeAllCustomSelects();
        if (!isOpen) {
          record.panel.classList.add("open");
          record.button.setAttribute("aria-expanded", "true");
          activeCustomSelect = record;
        }
      }

      function closeCustomSelect(record) {
        if (record.panel.classList.contains("open")) {
          record.panel.classList.remove("open");
          record.button.setAttribute("aria-expanded", "false");
          if (activeCustomSelect === record) {
            activeCustomSelect = null;
          }
        }
      }

      function closeAllCustomSelects() {
        customSelectRegistry.forEach((record) => {
          closeCustomSelect(record);
        });
      }

      document.addEventListener("click", (event) => {
        customSelectRegistry.forEach((record) => {
          if (!record.wrapper.contains(event.target)) {
            closeCustomSelect(record);
          }
        });
      });

      function refreshCustomSelect(selectEl) {
        const record = customSelectRegistry.get(selectEl);
        if (!record) return;
        updateCustomSelect(record);
      }

      function showDropMarker(container, beforeElement, insertIndex) {
        if (currentDropContainer === container && currentDropIndex === insertIndex && dropMarker.parentNode) {
          return;
        }
        clearDropMarker();
        const addSlot = container.querySelector(".day-add-slot");
        if (beforeElement) {
          container.insertBefore(dropMarker, beforeElement);
        } else if (addSlot) {
          container.insertBefore(dropMarker, addSlot);
        } else {
          container.appendChild(dropMarker);
        }
        currentDropContainer = container;
        currentDropIndex = insertIndex;
        container.classList.add("drag-over");
      }

      function handleDragOver(event) {
        event.preventDefault();
        const container = event.currentTarget;
        const tasks = Array.from(container.querySelectorAll(".task-block"));
        const y = event.clientY;
        let beforeElement = null;
        let insertIndex = tasks.length;
        for (let i = 0; i < tasks.length; i++) {
          const rect = tasks[i].getBoundingClientRect();
          if (y < rect.top + rect.height / 2) {
            beforeElement = tasks[i];
            insertIndex = i;
            break;
          }
        }
        showDropMarker(container, beforeElement, insertIndex);
      }

      document.addEventListener("dragend", () => {
        document.body.classList.remove("dragging");
        clearDropMarker();
      });

      function applyLanguage() {
        const dict = i18n[state.lang];
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.dataset.i18n;
          if (dict[key]) {
            el.textContent = dict[key];
          }
        });
        document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
          const key = el.dataset.i18nPlaceholder;
          if (dict[key]) {
            el.setAttribute("placeholder", dict[key]);
          }
        });
        updateLanguageToggle();
        renderWeekOptions();
      }

      function updateLanguageToggle() {
        languageToggle.querySelectorAll("span").forEach((span) => {
          span.classList.toggle("active", span.dataset.lang === state.lang);
        });
      }

      function updateExportToggle() {
        exportFormat.value = state.exportFormat;
      }

      languageToggle.addEventListener("click", (event) => {
        const target = event.target.closest("span");
        if (!target || !target.dataset.lang) {
          return;
        }
        state.lang = target.dataset.lang;
        localStorage.setItem("simpleCalendarLang", state.lang);
        applyLanguage();
        renderCalendar();
      });

      if (exportButton && exportDropdown) {
        exportButton.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = exportDropdown.classList.toggle("open");
          exportButton.setAttribute("aria-expanded", String(isOpen));
        });

        exportDropdown.addEventListener("click", (event) => {
          const target = event.target.closest("button");
          if (!target || !target.dataset.format) {
            return;
          }
          state.exportFormat = target.dataset.format;
          updateExportToggle();
          exportDropdown.classList.remove("open");
          exportButton.setAttribute("aria-expanded", "false");
          captureExport(state.exportFormat);
        });

        document.addEventListener("click", () => {
          if (!exportDropdown.classList.contains("open")) {
            return;
          }
          exportDropdown.classList.remove("open");
          exportButton.setAttribute("aria-expanded", "false");
        });
      }

      if (clearWeekButton) {
        clearWeekButton.addEventListener("click", () => {
          const monthLabel = monthDisplayText?.textContent || "";
          const weekLabel = `${i18n[state.lang].weekSelect} ${state.week}`;
          const label = monthLabel ? `${monthLabel} - ${weekLabel}` : weekLabel;
          if (isWeekEmpty(state.week, state.year)) {
            restoreWeekMessage.textContent =
              state.lang === "es"
                ? `¬øQuieres agregar bloques de ejemplo a esta semana?`
                : `Do you want to add sample blocks to this week?`;
            restoreWeekOverlay.classList.add("visible");
            return;
          }
          clearWeekMessage.innerHTML =
            state.lang === "es"
              ? `Seguro que quieres limpiar <strong>${label}</strong>?`
              : `Are you sure you want to Clean <strong>${label}</strong>?`;
          clearWeekOverlay.classList.add("visible");
        });
      }

      clearWeekCancel.addEventListener("click", () => {
        clearWeekOverlay.classList.remove("visible");
      });

      attachOverlayCloseGuard(clearWeekOverlay, () => {
        clearWeekOverlay.classList.remove("visible");
      });

      attachOverlayCloseGuard(restoreWeekOverlay, () => {
        restoreWeekOverlay.classList.remove("visible");
      });

      if (helpToggle && helpOverlay && helpClose) {
        helpToggle.addEventListener("click", () => {
          helpOverlay.classList.add("visible");
        });
        helpClose.addEventListener("click", () => {
          helpOverlay.classList.remove("visible");
        });
        attachOverlayCloseGuard(helpOverlay, () => {
          helpOverlay.classList.remove("visible");
        });
      }

      attachOverlayCloseGuard(moveOverlay, () => {
        moveOverlay.classList.remove("visible");
      });

      attachOverlayCloseGuard(deleteConfirmOverlay, () => {
        deleteConfirmOverlay.classList.remove("visible");
      });

      clearWeekConfirm.addEventListener("click", () => {
        clearWeekOverlay.classList.remove("visible");
        clearCurrentWeek();
        if (clearWeekButton) {
          clearWeekButton.textContent = "‚ûï";
        }
      });

      restoreWeekCancel.addEventListener("click", () => {
        restoreWeekOverlay.classList.remove("visible");
      });

      restoreWeekConfirm.addEventListener("click", () => {
        restoreWeekOverlay.classList.remove("visible");
        restoreSampleWeek();
        if (clearWeekButton) {
          clearWeekButton.textContent = "üóëÔ∏è";
        }
      });

      function setTitleError(show) {
        titleError.style.display = show ? "block" : "none";
      }

      function renderYearOptions() {
        yearSelect.innerHTML = "";
        years.forEach((yr) => {
          const option = document.createElement("option");
          option.value = yr;
          option.textContent = String(yr);
          if (yr === state.year) option.selected = true;
          yearSelect.appendChild(option);
        });
        refreshCustomSelect(yearSelect);
      }

      function syncSelectWidth(select, display, textOverride = "") {
        if (!select) return;
        const text = textOverride || select.options?.[select.selectedIndex]?.text || "";
        const ruler = document.createElement("span");
        ruler.style.position = "absolute";
        ruler.style.visibility = "hidden";
        ruler.style.whiteSpace = "nowrap";
        ruler.style.font = getComputedStyle(select).font;
        ruler.textContent = text;
        document.body.appendChild(ruler);
        const width = Math.ceil(ruler.getBoundingClientRect().width + 6);
        select.style.width = `${width}px`;
        if (display) {
          display.style.width = `${width}px`;
        }
        document.body.removeChild(ruler);
      }

      function renderMonthOptions(locale) {
        monthSelect.innerHTML = "";
        for (let i = 0; i < 12; i++) {
          const option = document.createElement("option");
          const label = new Date(Date.UTC(state.year, i, 1)).toLocaleString(locale, { month: "long" });
          const titleCase = label ? label[0].toUpperCase() + label.slice(1) : "";
          option.value = i;
          option.textContent = titleCase;
          if (i === state.month) option.selected = true;
          monthSelect.appendChild(option);
        }
        syncSelectWidth(monthSelect, monthDisplay, monthDisplayText?.textContent || "");
        refreshCustomSelect(monthSelect);
      }

      function getISOWeekDates(week, year, locale) {
        const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
        const dayOfWeek = simple.getUTCDay();
        const ISOWeekStart =
          dayOfWeek <= 4
            ? new Date(simple.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1))
            : new Date(simple.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay()));

        const days = [];
        for (let i = 0; i < 7; i++) {
          const current = new Date(ISOWeekStart);
          current.setUTCDate(ISOWeekStart.getUTCDate() + i);
        const dayIndex = current.getUTCDay();
        days.push({
          date: current.getUTCDate(),
          monthIndex: current.getUTCMonth(),
          year: current.getUTCFullYear(),
          month: current.toLocaleString(locale, { month: "long" }).replace(/^./, c => c.toUpperCase()),
          name: current.toLocaleString(locale, { weekday: "long" }).replace(/^./, c => c.toUpperCase()),
          isWeekend: dayIndex === 0 || dayIndex === 6,
        });
        }
        return days;
      }

      function getISOWeekNumber(date) {
        const utcDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
        const dayNum = utcDate.getUTCDay() || 7;
        utcDate.setUTCDate(utcDate.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(utcDate.getUTCFullYear(), 0, 1));
        return Math.ceil(((utcDate - yearStart) / 86400000 + 1) / 7);
      }

      function getWeeksInYear(year) {
        const date = new Date(Date.UTC(year, 11, 28));
        return getISOWeekNumber(date);
      }

      function getFirstWeekOfMonth(year, month) {
        const date = new Date(Date.UTC(year, month, 1));
        return getISOWeekNumber(date);
      }

      function getWeekKey(week, year) {
        return `${year}-${String(week).padStart(2, "0")}`;
      }

      function isWeekEmpty(week, year) {
        const weekKey = getWeekKey(week, year);
        const weekTasks = state.tasks[weekKey];
        if (!weekTasks) return true;
        return Object.values(weekTasks).every((tasks) => !tasks || tasks.length === 0);
      }

      function countBlocksInWeek(week, year) {
        const weekKey = getWeekKey(week, year);
        const weekTasks = state.tasks[weekKey];
        if (!weekTasks) return 0;
        return Object.values(weekTasks).reduce((sum, tasks) => sum + (tasks?.length || 0), 0);
      }

      function getWeekPrimaryMonth(week, year) {
        const days = getISOWeekDates(week, year, "en-US");
        // Find the last day that belongs to the specified year
        // This handles week 1 (might start in prev year) and week 53 (might end in next year)
        for (let i = 6; i >= 0; i--) {
          if (days[i].year === year) {
            return days[i].monthIndex;
          }
        }
        // Fallback: use first day in the correct year
        for (let i = 0; i < 7; i++) {
          if (days[i].year === year) {
            return days[i].monthIndex;
          }
        }
        return days[0].monthIndex;
      }

      function getWeekMonthsInYear(week, year) {
        // Returns only the months that belong to the specified year
        const days = getISOWeekDates(week, year, "en-US");
        const monthsInYear = new Set();
        days.forEach(day => {
          if (day.year === year) {
            monthsInYear.add(day.monthIndex);
          }
        });
        return monthsInYear;
      }

      function renderWeekDots() {
        const container = document.getElementById("week-dots-strip");
        if (!container) return;
        container.innerHTML = "";
        const totalWeeks = getWeeksInYear(state.year);
        const prefix = i18n[state.lang]?.weekPrefix || "W";
        const locale = state.lang === "es" ? "es-ES" : "en-US";

        // Get current week's months (only those in the current year)
        const highlightedMonths = getWeekMonthsInYear(state.week, state.year);

        // Group weeks by month
        const monthGroups = new Map();
        for (let week = 1; week <= totalWeeks; week++) {
          const monthIndex = getWeekPrimaryMonth(week, state.year);
          if (!monthGroups.has(monthIndex)) {
            const monthName = new Date(Date.UTC(state.year, monthIndex, 1))
              .toLocaleString(locale, { month: "short" }).replace(".", "");
            monthGroups.set(monthIndex, {
              monthIndex,
              monthName: monthName.charAt(0).toUpperCase() + monthName.slice(1),
              weeks: []
            });
          }
          monthGroups.get(monthIndex).weeks.push(week);
        }

        // Create content container
        const content = document.createElement("div");
        content.className = "week-dots-content";

        // Create month groups
        monthGroups.forEach((group) => {
          const monthGroup = document.createElement("div");
          monthGroup.className = "week-dots-month-group";
          if (highlightedMonths.has(group.monthIndex)) {
            monthGroup.classList.add("is-current-month");
          }

          // Dots container
          const dotsContainer = document.createElement("div");
          dotsContainer.className = "week-dots-month-dots";

          // Create dots for each week in this month
          group.weeks.forEach((week) => {
            const dot = document.createElement("div");
            dot.className = "week-dot";
            dot.dataset.week = week;

            const blockCount = countBlocksInWeek(week, state.year);
            if (blockCount > 0) {
              dot.classList.add("has-content");
            }

            if (week === state.week) {
              dot.classList.add("is-current");
            }

            const tooltip = document.createElement("span");
            tooltip.className = "week-dot-tooltip";
            const blockLabel = state.lang === "es"
              ? (blockCount === 1 ? "bloque" : "bloques")
              : (blockCount === 1 ? "block" : "blocks");
            tooltip.textContent = `${prefix}${String(week).padStart(2, "0")} ¬∑ ${blockCount} ${blockLabel}`;
            dot.appendChild(tooltip);

            dot.addEventListener("click", () => {
              state.week = week;
              weekSelect.value = state.week;
              renderCalendar();
            });

            dotsContainer.appendChild(dot);
          });

          // Month label
          const label = document.createElement("span");
          label.className = "week-dots-month-label";
          label.textContent = group.monthName;

          monthGroup.appendChild(dotsContainer);
          monthGroup.appendChild(label);
          content.appendChild(monthGroup);
        });

        container.appendChild(content);
      }

      function clearCurrentWeek() {
        const weekKey = getWeekKey(state.week, state.year);
        if (state.tasks[weekKey]) {
          delete state.tasks[weekKey];
        }
        saveTasks(state.tasks);
        renderTasks();
        renderWeekDots();
      }

      function restoreSampleWeek() {
        const weekKey = getWeekKey(state.week, state.year);
        const locale = state.lang === "es" ? "es-ES" : "en-US";
        const days = getISOWeekDates(state.week, state.year, locale);
          const sampleTasks = getSampleTasks(state.lang, paletteColors);

        if (!state.tasks[weekKey]) {
          state.tasks[weekKey] = {};
        }
        for (let i = 0; i < sampleTasks.length && i < days.length; i++) {
          const dayNum = days[i].date;
          if (!state.tasks[weekKey][dayNum]) {
            state.tasks[weekKey][dayNum] = [];
          }
          sampleTasks[i].forEach((task) => {
            state.tasks[weekKey][dayNum].push({ ...task });
          });
        }
        saveTasks(state.tasks);
        renderTasks();
        renderWeekDots();
      }

      function renderWeekOptions() {
        weekSelect.innerHTML = "";
        const totalWeeks = getWeeksInYear(state.year);
        for (let i = 1; i <= totalWeeks; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = `${i18n[state.lang].weekSelect} ${String(i).padStart(2, "0")}`;
          if (i === state.week) option.selected = true;
          weekSelect.appendChild(option);
        }
        refreshCustomSelect(weekSelect);
      }

      function populateMoveYearOptions(selectedYear = state.year) {
        if (!moveYearSelect) return;
        moveYearSelect.innerHTML = "";
        years.forEach((yr) => {
          const option = document.createElement("option");
          option.value = yr;
          option.textContent = String(yr);
          if (yr === selectedYear) option.selected = true;
          moveYearSelect.appendChild(option);
        });
        refreshCustomSelect(moveYearSelect);
      }

      function populateMoveWeekOptions(year, defaultWeek = state.week) {
        if (!moveWeekSelect) return;
        moveWeekSelect.innerHTML = "";
        const totalWeeks = getWeeksInYear(year);
        const prefix = i18n[state.lang]?.weekPrefix || "W";
        for (let wk = 1; wk <= totalWeeks; wk++) {
          const option = document.createElement("option");
          option.value = wk;
          option.textContent = `${prefix}${String(wk).padStart(2, "0")}`;
          if (wk === defaultWeek) option.selected = true;
          moveWeekSelect.appendChild(option);
        }
        refreshCustomSelect(moveWeekSelect);
      }

      function updateMoveDayOptions(preferredDay = null) {
        if (!moveWeekSelect || !moveDaySelect || !moveYearSelect) return;
        const locale = state.lang === "es" ? "es-ES" : "en-US";
        const year = Number(moveYearSelect.value) || state.year;
        const week = Number(moveWeekSelect.value) || state.week;
        const days = getISOWeekDates(week, year, locale);
        moveDaySelect.innerHTML = "";
        let matched = false;
        days.forEach((dayInfo) => {
          const option = document.createElement("option");
          option.value = dayInfo.date;
          option.textContent = `${dayInfo.name} ${dayInfo.date}`;
          if (preferredDay !== null && dayInfo.date === preferredDay) {
            option.selected = true;
            matched = true;
          }
          moveDaySelect.appendChild(option);
        });
        if (!matched && days.length) {
          moveDaySelect.value = days[0].date;
        }
        refreshCustomSelect(moveDaySelect);
      }

      function openMoveOverlay() {
        if (!editingTask || !moveOverlay) return;
        populateMoveYearOptions(state.year);
        populateMoveWeekOptions(state.year, state.week);
        updateMoveDayOptions(editingTask.day);
        moveOverlay.classList.add("visible");
      }

      function moveBlockToTarget(targetYear, targetWeek, targetDay) {
        if (!editingTask) return;
        const tasks = getTasksForDay(editingTask.day);
        const [moved] = tasks.splice(editingTask.index, 1);
        setTasksForDay(editingTask.day, tasks);
        const targetKey = getWeekKey(targetWeek, targetYear);
        if (!state.tasks[targetKey]) {
          state.tasks[targetKey] = {};
        }
        if (!state.tasks[targetKey][targetDay]) {
          state.tasks[targetKey][targetDay] = [];
        }
        state.tasks[targetKey][targetDay].push(moved);
        saveTasks(state.tasks);
        editingTask = null;
        formDirty = false;
        state.year = targetYear;
        state.week = targetWeek;
        yearSelect.value = state.year;
        weekSelect.value = state.week;
        closeModal(true);
        renderCalendar();
      }

      function updateControls(days) {
        taskDaySelect.innerHTML = "";
        days.forEach((day) => {
          const option = document.createElement("option");
          option.value = day.date;
          option.textContent = `${day.name} ${day.date}`;
          taskDaySelect.appendChild(option);
        });
        if (!lastSelectedDay) {
          lastSelectedDay = days[0].date;
        }
        taskDaySelect.value = lastSelectedDay;
        refreshCustomSelect(taskDaySelect);
        const weekLabel = `${i18n[state.lang].weekSelect} ${state.week}`;
        weekText.textContent = weekLabel;
        if (!monthLock) {
          state.month = days[3].monthIndex;
        }
        const locale = state.lang === "es" ? "es-ES" : "en-US";
        const start = days[0];
        const end = days[6];
        const startLabelRaw = new Date(Date.UTC(start.year, start.monthIndex, 1)).toLocaleString(locale, {
          month: "long",
        });
        const endLabelRaw = new Date(Date.UTC(end.year, end.monthIndex, 1)).toLocaleString(locale, {
          month: "long",
        });
        const startLabel = startLabelRaw ? startLabelRaw[0].toUpperCase() + startLabelRaw.slice(1) : "";
        const endLabel = endLabelRaw ? endLabelRaw[0].toUpperCase() + endLabelRaw.slice(1) : "";
        const monthRange = startLabel === endLabel ? startLabel : `${startLabel} | ${endLabel}`;
        monthText.textContent = monthRange;
        monthDisplayText.textContent = monthRange;
        syncSelectWidth(monthSelect, monthDisplay, monthRange);
        yearText.textContent = state.year;
        monthSelect.value = String(state.month);
        monthLock = false;
        if (clearWeekButton) {
          clearWeekButton.textContent = isWeekEmpty(state.week, state.year) ? "‚ûï" : "üóëÔ∏è";
        }
      }

      function createDayCell(day) {
        const cell = document.createElement("div");
        cell.className = "day-cell";
        if (day.isWeekend) {
          cell.classList.add("weekend");
        }
        cell.dataset.day = day.date;
        cell.innerHTML = `
          <div class="day-header">
            <div>
              <div class="day-number">${day.date}</div>
              <div class="day-name">${day.name}</div>
            </div>
          </div>
          <div class="day-tasks" data-day="${day.date}"></div>
        `;

        const taskContainer = cell.querySelector(".day-tasks");
        taskContainer.addEventListener("dragover", handleDragOver);
        taskContainer.addEventListener("drop", handleDrop);

        return cell;
      }

      function renderCalendar() {
        calendarGrid.innerHTML = "";
        const locale = state.lang === "es" ? "es-ES" : "en-US";
        renderWeekOptions();
        renderMonthOptions(locale);
        const days = getISOWeekDates(state.week, state.year, locale);
        updateControls(days);
        days.forEach((day) => {
          calendarGrid.appendChild(createDayCell(day));
        });
        renderTasks();
        renderWeekDots();
      }

      function getTasksForDay(day) {
        const weekKey = getWeekKey(state.week, state.year);
        const weekTasks = state.tasks[weekKey] || {};
        return weekTasks[day] || [];
      }

      function setTasksForDay(day, tasks) {
        const weekKey = getWeekKey(state.week, state.year);
        if (!state.tasks[weekKey]) state.tasks[weekKey] = {};
        state.tasks[weekKey][day] = tasks;
        saveTasks(state.tasks);
      }

      function createTaskBlock(task, day, index) {
        const block = document.createElement("div");
        block.className = "task-block";
        block.dataset.day = day;
        block.dataset.index = index;
        block.dataset.type = task.type;
        block.style.background = task.color;
        block.draggable = true;
        const titleEl = document.createElement("div");
        titleEl.className = "task-title";
        titleEl.textContent = task.title || "";
        const descEl = document.createElement("div");
        descEl.className = "task-description";
        descEl.textContent = task.description || "";
        const icon = document.createElement("span");
        icon.className = "edit-icon";
        icon.textContent = "‚úé";
        block.append(titleEl, descEl, icon);
        block.addEventListener("dragstart", (event) => {
          document.body.classList.add("dragging");
          event.dataTransfer.setData(
            "text/plain",
            JSON.stringify({
              week: state.week,
              year: state.year,
              day,
              index,
            })
          );
        });
        block.addEventListener("click", () => openModal(day, task, index));
        block.addEventListener("mouseenter", () => {
          const cell = block.closest(".day-cell");
          if (cell) cell.classList.add("hide-add");
        });
        block.addEventListener("mouseleave", () => {
          const cell = block.closest(".day-cell");
          if (cell) cell.classList.remove("hide-add");
        });
        return block;
      }

      function renderTasks() {
        document.querySelectorAll(".day-tasks").forEach((container) => {
          const day = Number(container.dataset.day);
          container.innerHTML = "";
          getTasksForDay(day).forEach((task, index) => {
            container.appendChild(createTaskBlock(task, day, index));
          });
          const addSlot = document.createElement("div");
          addSlot.className = "day-add-slot";
          addSlot.dataset.day = day;
          addSlot.textContent = "+";
          addSlot.addEventListener("click", () => openModal(day));
          container.appendChild(addSlot);
        });
      }

      function addTask(day, title, description, color, type = "task") {
        const tasks = getTasksForDay(day);
        tasks.push({ title, description, color, type });
        setTasksForDay(day, tasks);
        renderTasks();
        renderWeekDots();
      }

      function handleDrop(event) {
        event.preventDefault();
        document.body.classList.remove("dragging");
        const raw = event.dataTransfer.getData("text/plain");
        if (!raw) return;
        let payload = null;
        try {
          payload = JSON.parse(raw);
        } catch (error) {
          return;
        }
        const targetDay = Number(event.currentTarget.dataset.day);
        if (payload.week !== state.week || payload.year !== state.year) return;
        const tasks = getTasksForDay(payload.day);
        const [moved] = tasks.splice(payload.index, 1);
        setTasksForDay(payload.day, tasks);
        const destination = getTasksForDay(targetDay);
        let insertIndex = destination.length;
        if (dropMarker.parentNode === event.currentTarget) {
          let count = 0;
          for (const child of event.currentTarget.children) {
            if (child === dropMarker) {
              insertIndex = count;
              break;
            }
            if (child.classList && child.classList.contains("task-block")) {
              count += 1;
            }
          }
        } else if (currentDropIndex !== null) {
          insertIndex = currentDropIndex;
        }
        if (payload.day === targetDay && payload.index < insertIndex) {
          insertIndex -= 1;
        }
        insertIndex = Math.min(Math.max(insertIndex, 0), destination.length);
        destination.splice(insertIndex, 0, moved);
        setTasksForDay(targetDay, destination);
        clearDropMarker();
        renderTasks();
        renderWeekDots();
      }

      function selectPaletteColor(color, markDirty = true) {
        state.color = color;
        document.querySelectorAll(".palette button").forEach((btn) => {
          btn.classList.toggle("selected", btn.dataset.color === color);
        });
        if (markDirty) {
          formDirty = true;
        }
      }

      function initPalette() {
        paletteEl.innerHTML = "";
        paletteColors.forEach((color, index) => {
          const button = document.createElement("button");
          button.type = "button";
          button.style.background = color;
          button.dataset.color = color;
          if (index === 0) button.classList.add("selected");
          button.addEventListener("click", () => selectPaletteColor(color));
          paletteEl.appendChild(button);
        });
      }

      function applyPaletteTheme() {
        const isDark = document.body.classList.contains("dark");
        const fromColors = isDark ? lightPaletteColors : darkPaletteColors;
        const toColors = isDark ? darkPaletteColors : lightPaletteColors;
        paletteColors = toColors;
        Object.values(state.tasks).forEach((weekTasks) => {
          Object.values(weekTasks).forEach((dayTasks) => {
            dayTasks.forEach((task) => {
              const idx = fromColors.indexOf(task.color);
              if (idx >= 0 && toColors[idx]) {
                task.color = toColors[idx];
              }
            });
          });
        });
        if (!paletteColors.includes(state.color)) {
          state.color = paletteColors[0];
        }
        initPalette();
        saveTasks(state.tasks);
        renderTasks();
      }

      let lastSelectedDay = null;
      function openModal(day = null, task = null, index = null) {
        const titleInput = document.getElementById("task-title");
        const descInput = document.getElementById("task-description");
        taskForm.reset();
        formDirty = false;
        setTitleError(false);
        const fallback =
          day ??
          lastSelectedDay ??
          Number(taskDaySelect.value) ??
          Number(taskDaySelect.options?.[0]?.value) ??
          null;
        if (fallback !== null) {
          taskDaySelect.value = fallback;
          lastSelectedDay = fallback;
          refreshCustomSelect(taskDaySelect);
        }
        if (task) {
          editingTask = { day, index };
          titleInput.value = task.title;
          descInput.value = task.description;
          selectPaletteColor(task.color || state.color, false);
          deleteButton.style.display = "inline-flex";
          if (moveButton) {
            moveButton.style.display = "inline-flex";
          }
        } else {
          editingTask = null;
          titleInput.value = "";
          descInput.value = "";
          selectPaletteColor(state.color, false);
          deleteButton.style.display = "none";
          if (moveButton) {
            moveButton.style.display = "none";
          }
        }
        modalOverlay.classList.add("visible");
        document.body.style.overflow = "hidden";
      }

      function closeModal(force = false) {
        if (!force && formDirty) {
          confirmOverlay.classList.add("visible");
          return;
        }
        modalOverlay.classList.remove("visible");
        document.body.style.overflow = "";
        taskForm.reset();
        selectPaletteColor(state.color, false);
        editingTask = null;
        formDirty = false;
      }

      function saveForm(force = false) {
        const formData = new FormData(taskForm);
        const day = Number(formData.get("day")) || Number(taskDaySelect.value);
        const title = formData.get("title").trim();
        const desc = formData.get("description").trim();
        if (!force && !formDirty && !editingTask) {
          return false;
        }
        const color = state.color;
        if (!title) {
          setTitleError(true);
          return false;
        }
        if (editingTask) {
          const originalTasks = getTasksForDay(editingTask.day);
          if (originalTasks[editingTask.index]) {
            const [existing] = originalTasks.splice(editingTask.index, 1);
            setTasksForDay(editingTask.day, originalTasks);
            const destination = getTasksForDay(day);
            destination.splice(
              day === editingTask.day ? editingTask.index : destination.length,
              0,
              {
                title,
                description: desc,
                color,
                type: existing.type || "task",
              }
            );
            setTasksForDay(day, destination);
          }
          renderTasks();
          renderWeekDots();
        } else {
          addTask(day, title, desc, color);
        }
        formDirty = false;
        editingTask = null;
        setTitleError(false);
        return true;
      }

      function deleteEditingTask() {
        if (!editingTask) {
          return;
        }
        const tasks = getTasksForDay(editingTask.day);
        tasks.splice(editingTask.index, 1);
        setTasksForDay(editingTask.day, tasks);
        editingTask = null;
        renderTasks();
        renderWeekDots();
        closeModal(true);
      }

      closeModalButton.addEventListener("click", closeModal);

      attachOverlayCloseGuard(modalOverlay, () => {
        closeModal();
      });

      confirmStay.addEventListener("click", () => {
        confirmOverlay.classList.remove("visible");
      });

      confirmDiscard.addEventListener("click", () => {
        confirmOverlay.classList.remove("visible");
        closeModal(true);
      });

      deleteConfirmCancel.addEventListener("click", () => {
        deleteConfirmOverlay.classList.remove("visible");
      });

      deleteConfirmConfirm.addEventListener("click", () => {
        deleteConfirmOverlay.classList.remove("visible");
        deleteEditingTask();
      });

      taskForm.addEventListener("input", () => {
        formDirty = true;
        if (document.getElementById("task-title").value.trim()) {
          setTitleError(false);
        }
      });

      taskDaySelect.addEventListener("change", () => {
        formDirty = true;
        lastSelectedDay = Number(taskDaySelect.value);
      });

      taskForm.addEventListener("submit", (event) => {
        event.preventDefault();
        if (!saveForm(true)) {
          return;
        }
        closeModal(true);
      });

      if (moveButton) {
        moveButton.addEventListener("click", openMoveOverlay);
      }
      if (moveYearSelect) {
        moveYearSelect.addEventListener("change", () => {
          const selectedYear = Number(moveYearSelect.value) || state.year;
          const defaultWeek = selectedYear === state.year ? state.week : 1;
          populateMoveWeekOptions(selectedYear, defaultWeek);
          updateMoveDayOptions();
        });
      }
      if (moveWeekSelect) {
        moveWeekSelect.addEventListener("change", () => {
          updateMoveDayOptions();
        });
      }
      if (moveCancelButton) {
        moveCancelButton.addEventListener("click", () => {
          moveOverlay.classList.remove("visible");
        });
      }
      if (moveConfirmButton) {
        moveConfirmButton.addEventListener("click", () => {
          if (!moveYearSelect || !moveWeekSelect || !moveDaySelect) return;
          const targetYear = Number(moveYearSelect.value) || state.year;
          const targetWeek = Number(moveWeekSelect.value) || state.week;
          const targetDay = Number(moveDaySelect.value) || editingTask?.day || lastSelectedDay || 1;
          moveOverlay.classList.remove("visible");
          moveBlockToTarget(targetYear, targetWeek, targetDay);
        });
      }

      deleteButton.addEventListener("click", () => {
        if (!editingTask) return;
        deleteConfirmOverlay.classList.add("visible");
      });

      cancelButton.addEventListener("click", () => {
        closeModal(true);
      });

      function setThemeToggleIcon() {
        const isDark = document.body.classList.contains("dark");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        themeToggle.setAttribute("aria-label", isDark ? "Switch to light mode" : "Switch to dark mode");
      }

      themeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        localStorage.setItem(
          "simpleCalendarTheme",
          document.documentElement.classList.contains("dark") ? "dark" : "light"
        );
        applyPaletteTheme();
        setThemeToggleIcon();
      });

      weekSelect.addEventListener("change", (event) => {
        state.week = Number(event.target.value);
        renderCalendar();
      });

      monthSelect.addEventListener("change", (event) => {
        state.month = Number(event.target.value);
        state.week = getFirstWeekOfMonth(state.year, state.month);
        monthLock = true;
        renderCalendar();
      });

      yearSelect.addEventListener("change", (event) => {
        state.year = Number(event.target.value);
        state.week = getFirstWeekOfMonth(state.year, state.month ?? 0);
        renderCalendar();
      });

      document.getElementById("prev-week").addEventListener("click", () => {
        state.week = Math.max(1, state.week - 1);
        weekSelect.value = state.week;
        renderCalendar();
      });

      document.getElementById("next-week").addEventListener("click", () => {
        state.week = Math.min(getWeeksInYear(state.year), state.week + 1);
        weekSelect.value = state.week;
        renderCalendar();
      });

      document.getElementById("prev-month").addEventListener("click", () => {
        const nextMonth = (state.month ?? 0) - 1;
        if (nextMonth < 0) {
          const yearIndex = years.indexOf(state.year);
          if (yearIndex > 0) {
            state.year = years[yearIndex - 1];
            yearSelect.value = state.year;
            state.month = 11;
          } else {
            return;
          }
        } else {
          state.month = nextMonth;
        }
        state.week = getFirstWeekOfMonth(state.year, state.month);
        monthLock = true;
        renderCalendar();
      });

      document.getElementById("next-month").addEventListener("click", () => {
        const nextMonth = (state.month ?? 0) + 1;
        if (nextMonth > 11) {
          const yearIndex = years.indexOf(state.year);
          if (yearIndex < years.length - 1) {
            state.year = years[yearIndex + 1];
            yearSelect.value = state.year;
            state.month = 0;
          } else {
            return;
          }
        } else {
          state.month = nextMonth;
        }
        state.week = getFirstWeekOfMonth(state.year, state.month);
        monthLock = true;
        renderCalendar();
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeAllCustomSelects();
          if (moveOverlay && moveOverlay.classList.contains("visible")) {
            moveOverlay.classList.remove("visible");
            event.preventDefault();
            return;
          }
          if (deleteConfirmOverlay && deleteConfirmOverlay.classList.contains("visible")) {
            deleteConfirmOverlay.classList.remove("visible");
            event.preventDefault();
            return;
          }
          if (modalOverlay.classList.contains("visible")) {
            closeModal(true);
            event.preventDefault();
            return;
          }
        }
        if (
          event.target &&
          (event.target.tagName === "INPUT" ||
            event.target.tagName === "TEXTAREA" ||
            event.target.tagName === "SELECT" ||
            event.target.isContentEditable) &&
          event.key !== "Escape"
        ) {
          return;
        }
        if (event.key === "ArrowLeft") {
          event.preventDefault();
          state.week = Math.max(1, state.week - 1);
          renderCalendar();
          return;
        }
        if (event.key === "ArrowRight") {
          event.preventDefault();
          state.week = Math.min(getWeeksInYear(state.year), state.week + 1);
          renderCalendar();
          return;
        }
        if (event.key === "ArrowUp") {
          event.preventDefault();
          const nextMonth = (state.month ?? 0) + 1;
          if (nextMonth > 11) {
            const yearIndex = years.indexOf(state.year);
            if (yearIndex < years.length - 1) {
              state.year = years[yearIndex + 1];
              yearSelect.value = state.year;
              state.month = 0;
            } else {
              return;
            }
          } else {
            state.month = nextMonth;
          }
          state.week = getFirstWeekOfMonth(state.year, state.month);
          monthLock = true;
          renderCalendar();
          return;
        }
        if (event.key === "ArrowDown") {
          event.preventDefault();
          const nextMonth = (state.month ?? 0) - 1;
          if (nextMonth < 0) {
            const yearIndex = years.indexOf(state.year);
            if (yearIndex > 0) {
              state.year = years[yearIndex - 1];
              yearSelect.value = state.year;
              state.month = 11;
            } else {
              return;
            }
          } else {
            state.month = nextMonth;
          }
          state.week = getFirstWeekOfMonth(state.year, state.month);
          monthLock = true;
          renderCalendar();
        }
        if (event.key === "Home") {
          event.preventDefault();
          const startDate = new Date(Date.UTC(state.year, 0, 4));
          state.month = 0;
          state.week = getISOWeekNumber(startDate);
          monthLock = true;
          renderCalendar();
          return;
        }
        if (event.key === "End") {
          event.preventDefault();
          state.month = 11;
          state.week = getWeeksInYear(state.year);
          monthLock = true;
          renderCalendar();
        }
      });

      document.getElementById("prev-year").addEventListener("click", () => {
        const currentIndex = years.indexOf(state.year);
        if (currentIndex > 0) {
          state.year = years[currentIndex - 1];
          yearSelect.value = state.year;
          renderCalendar();
        }
      });

      document.getElementById("next-year").addEventListener("click", () => {
        const currentIndex = years.indexOf(state.year);
        if (currentIndex < years.length - 1) {
          state.year = years[currentIndex + 1];
          yearSelect.value = state.year;
          renderCalendar();
        }
      });

      async function captureExport(format = "png") {
        if (typeof html2canvas !== "function") {
          alert("Export requires html2canvas. Check your network connection.");
          return;
        }
        const target = document.querySelector(".calendar-wrapper");
        const exportNode = target.cloneNode(true);
        exportNode.classList.add("exporting");
        exportNode.style.position = "fixed";
        exportNode.style.left = "0";
        exportNode.style.top = "0";
        exportNode.style.transform = "translateX(-10000px)";
        exportNode.style.pointerEvents = "none";
        // Force desktop width for horizontal layout
        const desktopWidth = Math.max(target.offsetWidth, 1100);
        exportNode.style.width = `${desktopWidth}px`;
        // Force 7-column grid layout for export
        const exportGrid = exportNode.querySelector(".calendar-grid");
        if (exportGrid) {
          exportGrid.style.gridTemplateColumns = "repeat(7, minmax(0, 1fr))";
        }
        document.body.appendChild(exportNode);
        try {
          const canvas = await html2canvas(exportNode, { scale: 2 });
          if (format === "png") {
            const link = document.createElement("a");
            link.download = `calendar-w${String(state.week).padStart(2, "0")}-${state.year}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            return;
          }
          if (!window.jspdf) {
            alert("PDF export requires jsPDF. Please check your network connection.");
            return;
          }
          const { jsPDF } = window.jspdf;
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jsPDF({
            orientation: "landscape",
            unit: "pt",
            format: [canvas.width, canvas.height],
          });
          pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
          pdf.save(`calendar-w${String(state.week).padStart(2, "0")}-${state.year}.pdf`);
        } catch (error) {
          console.error("Export failed", error);
          alert("Something went wrong while capturing the calendar. Please try again.");
        } finally {
          exportNode.remove();
        }
      }

      renderYearOptions();
      const savedLang = localStorage.getItem("simpleCalendarLang");
      if (savedLang && i18n[savedLang]) {
        state.lang = savedLang;
      }
      applyLanguage();
      applyPaletteTheme();
      setThemeToggleIcon();
      updateExportToggle();
      const savedTheme = localStorage.getItem("simpleCalendarTheme");
      if (savedTheme === "dark") {
        document.documentElement.classList.add("dark");
        applyPaletteTheme();
        setThemeToggleIcon();
      }
      renderCalendar();
    </script>
  </body>
</html>







